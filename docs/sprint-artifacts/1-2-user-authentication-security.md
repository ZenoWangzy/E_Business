# Story 1.2: User Authentication & Security

Status: done

## Story

As a User,
I want to register and login securely,
So that I can access my private workspace.

## Acceptance Criteria

1. **Given** I am on the login page (`/login`)
2. **When** I enter a valid email and password OR click "Sign in with Google/GitHub"
3. **Then** I should be authenticated via NextAuth.js v5
4. **And** A session cookie containing an encrypted JWT (JWE) should be set
5. **And** I should be redirected to the dashboard (`/dashboard`)
6. **And** Subsequent requests to Backend API (`/api/v1/*`) should include this cookie
7. **And** The Backend should successfully decrypt the JWE and identify the user
8. **And** If I try to access `/dashboard` without login, I should be redirected to `/login`

## Tasks / Subtasks

- [x] Backend: Auth Infrastructure
  - [x] Install `python-jose[cryptography]` and `bcrypt`
  - [x] Implement `core/security.py`: Password hashing/verification
  - [x] Implement `api/deps.py`: `get_current_user` dependency with JWT Decryption
  - [x] Create `api/v1/endpoints/auth.py`: Login endpoint (for credentials provider)
- [x] Frontend: NextAuth v5 Setup
  - [x] Install `next-auth@beta`
  - [x] Create `src/auth.ts` configuration (Credentials + OAuth providers)
  - [x] Create `src/app/api/auth/[...nextauth]/route.ts` (handlers)
  - [x] Create `src/middleware.ts` for route protection
- [x] Frontend: UI Implementation
  - [x] Create `src/app/(auth)/login/page.tsx`
  - [x] Build `LoginForm` component (using shadcn Card, Input, Button)
  - [x] Implement "Sign in with Google/GitHub" buttons
- [x] Integration Verification
  - [x] Frontend build successful, TypeScript compiles
  - [x] Backend 40 unit tests pass, auth endpoints functional

## Dev Notes

### Architecture Patterns & Guardrails

- **Authentication Standard**: Use **NextAuth.js v5 (Beta)**. Do NOT use v4.
- **Token Format**: NextAuth v5 uses **JWE (Encrypted JWT)** by default.
  - **Crucial**: The Backend MUST validate this JWE. It is NOT a standard signed JWT.
  - **Decryption Key**: `AUTH_SECRET` (defined in `.env`).
  - **Decryption Salt**: The cookie name (e.g., `__Secure-authjs.session-token` or `authjs.session-token`).
- **API Boundary**:
  - Frontend (`src/auth.ts`) handles the initial login/OAuth handshake.
  - Backend (`FastAPI`) trusts the token generated by NextAuth.
  - Backend does NOT issue its own tokens (for this MVP phase).
- **Security**:
  - Passwords in DB must be hashed (bcrypt).
  - Use `HTTP-only`, `Secure`, `SameSite=Lax` cookies (NextAuth default).

### Technical Specifications

#### Backend JWE Decryption (Python)
Use `python-jose` to decrypt.
```python
# Pseudo-code for deps.py
from jose import jwt

def get_current_user(token: str = Cookie(alias="authjs.session-token")):
    try:
        # Steps to decrypt NextAuth v5 JWE:
        # 1. Derive key from AUTH_SECRET and Salt (Cookie Name) using HKDF
        # 2. Decrypt token using derived key and Direct Encryption (A256GCM)
        # Note: Validating v5 tokens in Python is complex. 
        # Recommendation: Use "python-jose" with direct key if possible, OR 
        # Configure NextAuth to use standard JWT (JWS) instead of JWE for MVP simplicity if JWE proves too hard.
        pass
    except Exception:
        raise HTTPException(401)
```
**Decision for MVP**: To avoid complex HKDF re-implementation in Python, **configure NextAuth to use standard Signed JWT (JWS)** or ensure the backend uses the exact same encryption secrets. 
*Alternative Simpler Path*: Configure `auth.ts` to use a specific signing key so it produces a standard JWS that `python-jose` can easily verify with a public key or shared secret.

### References

- [Architecture: Authentication](file:///Users/ZenoWang/Documents/project/E_Business/docs/architecture.md#authentication--security)
- [Project Context: API Response](file:///Users/ZenoWang/Documents/project/E_Business/docs/project_context.md#3-api-response-format)

## Dev Agent Record

### Context Reference
- **Epic**: [Story 1.2](file:///Users/ZenoWang/Documents/project/E_Business/docs/epics.md#story-12-user-authentication--security)
- **Previous Story**: [1.1 Environment Initialization](file:///Users/ZenoWang/Documents/project/E_Business/docs/sprint-artifacts/1-1-environment-initialization-db-migration.md)

### Agent Model Used
Google Gemini 2.5 Pro

### Completion Notes List
- ✅ Backend: Installed `python-jose[cryptography]` and `bcrypt` (direct API for Python 3.14 compatibility)
- ✅ Backend: Created `core/security.py` with password hashing and JWT token operations
- ✅ Backend: Created `api/deps.py` with `get_current_user` dependency reading NextAuth cookies
- ✅ Backend: Created `api/v1/endpoints/auth.py` with `/login` endpoint
- ✅ Backend: All 40 unit tests passing
- ✅ Frontend: Installed `next-auth@beta`
- ✅ Frontend: Created `auth.ts` with Credentials + Google/GitHub OAuth providers
- ✅ Frontend: Created `api/auth/[...nextauth]/route.ts`
- ✅ Frontend: Created `middleware.ts` for route protection
- ✅ Frontend: Created login page with modern UI (gradient background, glassmorphism)
- ✅ Frontend: Created `LoginForm` component with email/password and OAuth buttons
- ✅ Frontend: Created protected dashboard page
- ✅ Frontend: Build successful, TypeScript compiles

### Implementation Decision
- Used standard JWT (JWS) with HS256 instead of JWE for MVP simplicity
- Shared `AUTH_SECRET` between Frontend and Backend for token signing/verification

### Code Review Fixes (2025-12-14)
- ✅ **HIGH #1**: 修复前端middleware - 重写使用NextAuth v5的auth()包装器实现正确的路由保护
- ✅ **HIGH #3**: 实现 `/auth/me` endpoint - 替换501占位符，使用`get_current_user`依赖返回用户信息
- ✅ **HIGH #4**: 增强JWT验证 - 添加过期时间验证(`verify_exp: True`)
- ✅ **MEDIUM #7**: 改进CORS配置 - 从`allow_all`改为明确列出允许的methods和headers
- ✅ **MEDIUM #8**: 添加密码强度验证 - 最少8字符+数字/特殊字符，测试已更新
- ✅ 所有40个单元测试通过验证

## File List

### Backend (New/Modified)
- `backend/app/core/security.py` (NEW)
- `backend/app/core/config.py` (MODIFIED - added auth_secret)
- `backend/app/api/__init__.py` (NEW)
- `backend/app/api/deps.py` (NEW)
- `backend/app/api/v1/__init__.py` (NEW)
- `backend/app/api/v1/endpoints/__init__.py` (NEW)
- `backend/app/api/v1/endpoints/auth.py` (NEW)
- `backend/app/main.py` (MODIFIED - added auth router)
- `backend/app/tests/unit/test_security.py` (NEW)
- `backend/app/tests/unit/test_auth.py` (NEW)
- `backend/pyproject.toml` (MODIFIED - added dependencies)

### Frontend (New/Modified)
- `frontend/src/auth.ts` (NEW)
- `frontend/src/middleware.ts` (NEW)
- `frontend/src/app/api/auth/[...nextauth]/route.ts` (NEW)
- `frontend/src/app/(auth)/layout.tsx` (NEW)
- `frontend/src/app/(auth)/login/page.tsx` (NEW)
- `frontend/src/app/dashboard/page.tsx` (NEW)
- `frontend/src/components/auth/login-form.tsx` (NEW)
- `frontend/src/components/ui/button.tsx` (NEW - shadcn)
- `frontend/src/components/ui/input.tsx` (NEW - shadcn)
- `frontend/src/components/ui/label.tsx` (NEW - shadcn)
- `frontend/src/components/ui/card.tsx` (NEW - shadcn)
- `frontend/.env.local` (NEW)
- `frontend/.env.local.example` (NEW)
- `frontend/package.json` (MODIFIED - added next-auth)

## Change Log

| Date | Change |
|------|--------|
| 2025-12-14 06:00 | Implemented full authentication stack (Backend + Frontend) |
| 2025-12-14 06:30 | Code Review fixes: /auth/me endpoint, JWT验证, CORS配置, 密码强度, middleware |
